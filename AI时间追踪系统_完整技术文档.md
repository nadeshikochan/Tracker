# AI 时间追踪系统 - 完整技术文档

## 目录

1. [项目概述](#1-项目概述)
2. [系统架构](#2-系统架构)
3. [核心模块详解](#3-核心模块详解)
4. [数据流程](#4-数据流程)
5. [关键算法](#5-关键算法)
6. [配置系统](#6-配置系统)
7. [文件结构](#7-文件结构)
8. [技术栈](#8-技术栈)
9. [扩展指南](#9-扩展指南)

---

## 1. 项目概述

### 1.1 项目目标

这是一个运行在 Windows 桌面的时间追踪系统，它能够：

1. **自动记录**用户在电脑上的所有活动（打开的软件、访问的网站）
2. **智能分类**使用 AI 将活动自动归类（开发、学习、娱乐等）
3. **可视化展示**通过 Web 仪表盘展示时间使用报告
4. **目标追踪**设定每日目标并追踪完成进度

### 1.2 核心特性

| 特性 | 描述 |
|------|------|
| 窗口追踪 | 实时监控前台窗口，记录应用使用 |
| URL 捕获 | 支持主流浏览器的地址栏读取 |
| 活跃度检测 | 根据键鼠操作频率判断专注程度 |
| AI 分类 | 调用大语言模型进行智能分类 |
| 空闲检测 | 自动识别休息时间 |
| 跨天切割 | 正确处理跨越午夜的活动 |
| 休眠处理 | 正确处理系统休眠/唤醒 |

### 1.3 适用场景

- 个人时间管理和效率分析
- 工作时间统计
- 习惯追踪和改进
- 专注度提升

---

## 2. 系统架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        launcher.py                               │
│                      (系统托盘启动器)                              │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                     子进程管理                                │ │
│  │  ┌─────────────────┐        ┌─────────────────┐             │ │
│  │  │   tracker.py    │        │    webui.py     │             │ │
│  │  │   (追踪核心)     │        │   (Web界面)      │             │ │
│  │  └────────┬────────┘        └────────┬────────┘             │ │
│  │           │                          │                       │ │
│  │           ▼                          ▼                       │ │
│  │  ┌─────────────────┐        ┌─────────────────┐             │ │
│  │  │   CSV 日志文件   │◀──────▶│  Streamlit App  │             │ │
│  │  └─────────────────┘        └─────────────────┘             │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        common.py                                 │
│                      (公共工具模块)                               │
│  • 路径管理  • 配置加载  • 目标配置  • 日志记录                     │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 模块职责

| 模块 | 文件 | 主要职责 |
|------|------|----------|
| 启动器 | launcher.py | 进程管理、系统托盘 |
| 追踪核心 | tracker.py | 窗口监控、AI 分类 |
| Web 界面 | webui.py | 数据可视化 |
| 公共模块 | common.py | 配置、日志、路径 |
| CSV 修复 | fix_csv.py | 数据修复工具 |
| 打包工具 | build_exe.py | EXE 生成 |

### 2.3 进程模型

```
launcher.py (主进程)
    │
    ├── tracker.py (子进程 1)
    │   ├── InputMonitor 线程 (键鼠监听)
    │   └── AI 处理线程 (异步)
    │
    └── webui.py via Streamlit (子进程 2)
        └── Streamlit 服务器
```

---

## 3. 核心模块详解

### 3.1 tracker.py - 追踪核心

这是整个系统最核心的模块，包含 4 个主要类：

#### 3.1.1 InputMonitor - 输入监控器

**功能**：监听全局键盘和鼠标事件

**工作原理**：
```python
# 使用 pynput 库创建全局钩子
mouse_listener = mouse.Listener(on_click=..., on_move=...)
key_listener = keyboard.Listener(on_release=...)
```

**活跃度判定规则**：
| 操作次数 | 活跃度 |
|----------|--------|
| < 5 | 低 |
| 5-49 | 中 |
| ≥ 50 | 高 |

**线程安全**：使用 `threading.Lock` 保护共享计数器

#### 3.1.2 DataCollector - 数据采集器

**功能**：获取当前活动窗口的信息

**核心技术**：
1. **Windows API** (`win32gui`): 获取前台窗口句柄和标题
2. **psutil**: 通过 PID 获取进程名
3. **uiautomation**: 读取浏览器地址栏

**浏览器 URL 获取流程**：
```
窗口句柄 → ControlFromHandle → 定位 EditControl → GetValuePattern().Value
```

**缓存机制**：
- 进程名缓存：`{pid: process_name}`
- URL 缓存：每 2 秒最多查询一次

#### 3.1.3 AsyncAISummarizer - AI 处理器

**功能**：调用 AI API 对日志进行分类

**处理流程**：
```
原始日志 → 保存到 raw/ → 调用 AI → 解析 CSV → 保存结果
              ↓
         失败时保存到 failed/
```

**重试机制**：
- 默认重试 3 次
- 每次间隔 5 秒

**系统提示词设计**：
```
【9大分类规则】
1. 【开发】: 编写代码, 调试, 查阅技术文档, 终端操作
2. 【AI】: 使用 ChatGPT, Claude, Gemini 等AI工具
3. 【知识库】: 使用 Obsidian, Notion 等笔记软件
...

【输出要求】
1. 严格CSV格式，无表头，无多余解释
2. 每行：开始时间,结束时间,任务分类,任务详情
```

#### 3.1.4 SmartTracker - 智能追踪器

**功能**：核心控制器，协调所有组件

**状态机模型**：

```
                    ┌──────────────┐
                    │   稳定状态    │
                    │ (stable_*)   │
                    └──────┬───────┘
                           │ 检测到变化
                           ▼
                    ┌──────────────┐
                    │   待定状态    │
                    │ (pending_*)  │
                    └──────┬───────┘
                           │
           ┌───────────────┼───────────────┐
           │               │               │
      持续超过阈值      回到原状态      切换到新状态
           │               │               │
           ▼               ▼               ▼
      ┌─────────┐    ┌─────────┐    ┌─────────┐
      │确认切换  │    │丢弃待定  │    │更新待定  │
      └─────────┘    └─────────┘    └─────────┘
```

**防抖机制**：
- 窗口变化后等待 30 秒（可配置）
- 超过阈值才认为是真正的任务切换
- 避免临时查看其他窗口被误记

### 3.2 webui.py - Web 仪表盘

基于 Streamlit 构建的数据可视化界面。

#### 3.2.1 页面结构

```
┌─────────────────────────────────────────────────────────────┐
│  🎛️ 控制面板 (侧边栏)                                        │
│  ├── 🔄 刷新数据                                             │
│  ├── 📅 查看模式 (单日/日期范围/本周)                          │
│  └── 🏷️ 分类筛选                                            │
├─────────────────────────────────────────────────────────────┤
│  📊 核心指标卡片                                              │
│  ┌─────────┬─────────┬─────────┬─────────┐                  │
│  │总记录时长│ 覆盖天数 │ 活动条数 │ 平均时长 │                  │
│  └─────────┴─────────┴─────────┴─────────┘                  │
├─────────────────────────────────────────────────────────────┤
│  📑 标签页                                                   │
│  ├── 📊 总览 (饼图 + 柱状图)                                  │
│  ├── 🗓️ 时间轴 (甘特图)                                      │
│  ├── 🎯 目标追踪 (进度条)                                     │
│  └── 📝 数据明细 (可编辑表格)                                  │
└─────────────────────────────────────────────────────────────┘
```

#### 3.2.2 数据缓存

使用 `@st.cache_data` 装饰器：
- 相同参数的函数调用返回缓存结果
- TTL = 30 秒自动过期
- 点击"刷新数据"手动清除

#### 3.2.3 图表技术

使用 Plotly Express：
- 饼图：`px.pie()` with `hole=0.4`（环形图）
- 柱状图：`px.bar()` with `orientation='h'`（水平）
- 时间轴：`px.timeline()`（甘特图）

### 3.3 common.py - 公共模块

#### 3.3.1 路径管理

```python
BASE_DIR = os.path.dirname(os.path.abspath(__file__))  # 项目根目录
LOG_DIR = os.path.join(BASE_DIR, "logs")               # 日志目录
RAW_LOG_DIR = os.path.join(LOG_DIR, "raw")             # 原始日志
FAILED_LOG_DIR = os.path.join(LOG_DIR, "failed")       # 失败日志
CONFIG_PATH = os.path.join(BASE_DIR, "config.json")    # 配置文件
GOALS_PATH = os.path.join(BASE_DIR, "goals.json")      # 目标配置
```

#### 3.3.2 配置加载

使用默认值 + 文件覆盖的模式：
```python
default_config = {...}  # 默认配置
if os.path.exists(CONFIG_PATH):
    default_config.update(json.load(f))  # 文件配置覆盖
```

### 3.4 launcher.py - 系统托盘

#### 3.4.1 进程生命周期管理

```
启动 → tracker.py (后台)
    → webui.py via Streamlit (后台)
    → 监控线程 (每10秒检查)
        → 进程崩溃时自动重启
```

#### 3.4.2 托盘菜单

```
┌─────────────────────┐
│ Open Dashboard ✓    │  ← 双击默认操作
│ View Log           │
│ ──────────────     │
│ Exit               │
└─────────────────────┘
```

---

## 4. 数据流程

### 4.1 完整数据流

```
┌─────────────────────────────────────────────────────────────────┐
│                          用户操作                                │
│              (切换窗口、打开网页、键盘输入...)                      │
└───────────────────────────────┬─────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                       DataCollector                              │
│  • 获取窗口句柄 (win32gui)                                        │
│  • 获取进程名 (psutil)                                           │
│  • 获取浏览器URL (uiautomation)                                   │
└───────────────────────────────┬─────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                       SmartTracker                               │
│  • 防抖处理 (30秒阈值)                                            │
│  • 空闲检测 (5分钟阈值)                                           │
│  • 休眠处理                                                      │
│  • 跨天切割                                                      │
└───────────────────────────────┬─────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                        日志缓冲区                                 │
│  格式: [时间] <进程> [活跃度] [URL] 标题                           │
│  触发: 达到 batch_size 条                                        │
└───────────────────────────────┬─────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    AsyncAISummarizer                             │
│  1. 保存原始日志 → logs/raw/YYYY-MM-DD_raw.txt                    │
│  2. 调用 AI API (异步线程)                                        │
│  3. 解析返回的 CSV                                               │
│  4. 保存结果 → logs/YYYY-MM-DD.csv                               │
└───────────────────────────────┬─────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                         WebUI                                    │
│  • 读取 CSV 文件                                                  │
│  • 数据处理与聚合                                                 │
│  • Plotly 图表渲染                                               │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 日志格式

#### 原始日志（发送给 AI）

```
[2024-01-15 19:30:00 - 2024-01-15 20:15:00] <code.exe> [活跃度:高] VSCode - tracker.py
[2024-01-15 20:15:00 - 2024-01-15 20:30:00] <chrome.exe> [活跃度:中] [URL: https://github.com] GitHub
```

#### AI 返回结果（CSV）

```csv
19:30:00,20:15:00,开发,VSCode编写Python代码
20:15:00,20:30:00,开发,GitHub查看代码
```

#### 最终存储（logs/YYYY-MM-DD.csv）

```csv
开始时间,结束时间,任务分类,任务详情
19:30:00,20:15:00,开发,VSCode编写Python代码
20:15:00,20:30:00,开发,GitHub查看代码
```

---

## 5. 关键算法

### 5.1 窗口切换防抖

**问题**：用户频繁在多个窗口间切换，如何判断真正的任务切换？

**解决方案**：待定状态 + 时间阈值

```python
# 伪代码
if 当前窗口 != 稳定状态:
    if 没有待定状态:
        创建待定状态
    elif 当前窗口 == 待定状态:
        if 持续时间 > check_interval:
            确认切换: 稳定状态 = 待定状态
    else:
        更新待定状态
```

**参数**：`check_interval = 30` 秒（可配置）

### 5.2 空闲检测

**问题**：如何判断用户是在休息还是在思考（看屏幕但不操作）？

**解决方案**：基于最后活动时间

```python
idle_duration = time.time() - last_activity_time

if idle_duration > idle_timeout:  # 默认300秒
    标记为空闲状态
    提交之前的任务
elif 空闲状态 and idle_duration < 5:  # 有新活动
    提交空闲时段记录
    恢复正常追踪
```

### 5.3 休眠检测

**问题**：系统休眠期间 `time.time()` 会继续增长，导致时间计算错误

**解决方案**：使用 `time.monotonic()`

```python
# monotonic 时钟在休眠期间暂停
loop_gap = time.monotonic() - last_loop_monotonic

if loop_gap > sleep_threshold:  # 默认120秒
    # 检测到休眠
    提交休眠前的任务（减去休眠时间）
    重置状态
```

### 5.4 跨天切割

**问题**：活动从23:50持续到00:10，应该如何记录？

**解决方案**：递归拆分

```python
if start.date() != end.date():
    midnight = datetime.combine(start.date() + 1, datetime.min.time())
    
    # 递归调用，拆分为两条记录
    commit_log(..., start, midnight)  # 第一天的部分
    commit_log(..., midnight, end)    # 第二天的部分
```

### 5.5 浏览器 URL 获取

**问题**：不同浏览器的 UI 结构不同

**解决方案**：按浏览器类型定位

```python
if 'firefox' in process_name:
    edit = window.EditControl(AutomationId="urlbar-input")
elif 'edge' in process_name:
    edit = window.EditControl(Name="Address and search bar")
else:  # Chrome 等
    edit = window.EditControl(foundIndex=1)
```

---

## 6. 配置系统

### 6.1 config.json

```json
{
    "api_key": "your-api-key",           // AI 服务密钥（必填）
    "base_url": "https://api.openai.com/v1",  // API 地址
    "model": "gpt-3.5-turbo",            // 使用的模型
    "check_interval": 30,                // 防抖时间（秒）
    "batch_size": 5,                     // 批处理大小
    "idle_timeout": 300,                 // 空闲阈值（秒）
    "ai_retry_times": 3,                 // 重试次数
    "ai_retry_delay": 5,                 // 重试间隔（秒）
    "browser_processes": [               // 浏览器进程列表
        "chrome.exe",
        "msedge.exe",
        "firefox.exe"
    ]
}
```

### 6.2 goals.json

```json
{
    "enabled": true,                     // 是否启用目标追踪
    "targets": {                         // 各分类目标时长（分钟）
        "开发": 240,                     // 4小时
        "学习": 120,                     // 2小时
        "娱乐": 60                       // 1小时
    },
    "limits": ["娱乐", "社交"]           // 上限类型（不应超过）
}
```

### 6.3 配置优先级

```
默认值 < config.json 文件 < 运行时参数（如果有）
```

---

## 7. 文件结构

```
TimeTracker/
│
├── 📄 启动文件
│   ├── start.bat          # Windows 启动脚本
│   └── launcher.py        # 系统托盘启动器
│
├── 📄 核心模块
│   ├── tracker.py         # 追踪核心（最重要）
│   ├── webui.py           # Web 仪表盘
│   └── common.py          # 公共工具
│
├── 📄 工具脚本
│   ├── fix_csv.py         # CSV 修复工具
│   └── build_exe.py       # EXE 打包脚本
│
├── 📄 配置文件
│   ├── config.json        # 主配置（需要填写 API Key）
│   ├── goals.json         # 目标配置
│   └── requirements.txt   # Python 依赖
│
└── 📁 logs/               # 数据目录（自动创建）
    ├── 2024-01-15.csv     # 每日记录
    ├── raw/               # 原始日志备份
    ├── failed/            # 失败日志
    └── runtime.log        # 运行日志
```

---

## 8. 技术栈

### 8.1 核心依赖

| 库 | 版本 | 用途 |
|----|------|------|
| streamlit | ≥1.28 | Web 应用框架 |
| plotly | ≥5.18 | 交互式图表 |
| pandas | ≥2.0 | 数据处理 |
| psutil | ≥5.9 | 进程信息 |
| pywin32 | ≥306 | Windows API |
| uiautomation | ≥2.0 | UI 自动化 |
| pynput | ≥1.7 | 键鼠监听 |
| pystray | ≥0.19 | 系统托盘 |
| Pillow | ≥10.0 | 图像处理 |
| openai | ≥1.3 | AI API 客户端 |

### 8.2 系统要求

- **操作系统**：Windows 10/11
- **Python 版本**：3.8+
- **网络**：需要稳定网络（AI API 调用）

### 8.3 关键技术点

| 技术 | 应用场景 |
|------|----------|
| Windows API (win32gui) | 获取前台窗口信息 |
| UI Automation | 读取浏览器地址栏 |
| 全局钩子 (pynput) | 监听键盘鼠标 |
| 多线程 | AI 异步处理 |
| 子进程管理 | 服务启动和监控 |
| Streamlit | Web 界面 |
| Plotly | 数据可视化 |

---

## 9. 扩展指南

### 9.1 添加新的分类规则

修改 `tracker.py` 中的 `SYSTEM_PROMPT`：

```python
DEFAULT_SYSTEM_PROMPT = """
...
【9大分类规则】
1. 【开发】: ...
2. 【AI】: ...
...
10. 【新分类】: 描述什么情况归入此类
"""
```

### 9.2 支持新的浏览器

1. 在 `config.json` 中添加进程名：
```json
"browser_processes": [..., "新浏览器.exe"]
```

2. 如果 URL 获取有问题，在 `DataCollector.get_browser_url()` 中添加特殊处理。

### 9.3 添加新的数据源

在 `DataCollector` 类中添加新的采集方法：

```python
def get_new_data(self):
    # 实现新的数据采集逻辑
    pass
```

然后在 `SmartTracker.run()` 中调用。

### 9.4 自定义 Web 仪表盘

修改 `webui.py`：

1. 添加新的标签页：
```python
tab1, tab2, tab3, tab4, tab5 = st.tabs([..., "新标签"])
with tab5:
    # 新内容
```

2. 添加新的图表：
```python
fig = px.bar(...)  # 或其他 Plotly 图表
st.plotly_chart(fig)
```

### 9.5 更换 AI 服务

只需修改 `config.json`：

```json
{
    "api_key": "新服务的API Key",
    "base_url": "新服务的API地址",
    "model": "新服务的模型名"
}
```

只要服务兼容 OpenAI API 格式即可。

---

## 结语

这个项目是一个功能完整的时间追踪系统，涵盖了：

- **系统编程**：Windows API、进程管理
- **自动化**：UI 自动化、全局钩子
- **AI 集成**：大语言模型 API 调用
- **Web 开发**：Streamlit 应用
- **数据可视化**：Plotly 图表

希望这份文档能帮助你完全理解项目的架构和实现！
